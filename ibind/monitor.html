<!DOCTYPE html>
<html>

<head>
	<meta charset='utf-8' />
	<title>IBind Monitor</title>
	<style>
		body {
			margin: 0;
			font-family: system-ui, sans-serif;
			background: #1e1e1e;
			color: #eee;
		}

		#health {
			display: flex;
			gap: 1rem;
			padding: 0.5rem 1rem;
			background: #202020;
			border-bottom: 1px solid #333;
			position: sticky;
			top: 0;
			z-index: 1;
			box-shadow: 0 2px 4px rgba(0, 0, 0, 0.4);
		}

		.health-item {
			display: flex;
			align-items: center;
			font-size: 0.9rem;
		}

		.status {
			width: 12px;
			height: 12px;
			border-radius: 50%;
			margin-right: 0.4rem;
			background: #666;
			transition: background 0.3s;
		}

		.green {
			background: #4caf50;
		}

		.yellow {
			background: #ffc107;
		}

		.red {
			background: #f44336;
		}

		#log {
			margin: 0;
			padding: 0;
			height: calc(100vh - 48px);
			overflow-y: auto;
			font-family: monospace;
			font-size: 0.85rem;
		}

		.log-entry {
			display: grid;
			grid-template-columns: 140px 130px auto auto;
			gap: 0.5rem;
			padding: 0.25rem 0.75rem;
			border-bottom: 1px solid #2a2a2a;
		}

		.log-entry:nth-child(odd) {
			background: #252525;
		}

		.log-time {
			color: #888;
		}

		.log-endpoint {
			color: #4ea1ff;
			word-wrap: break-word;
		}

		.log-data {
			color: #ccc;
			white-space: pre-wrap;
			word-break: break-word;
		}

	</style>
</head>

<body>
	<div id='health'>
		<div class='health-item'><span id='gateway-status' class='status'></span>Gateway</div>
		<div class='health-item'><span id='auth-status' class='status'></span>Authenticated</div>
		<div class='health-item'><span id='connected-status' class='status'></span>Connected</div>
		<div class='health-item'><span id='competing-status' class='status'></span>Competing</div>
	</div>
	<div id='log'></div>
	<script>
		const log = document.getElementById('log');
		const ws = new WebSocket(`ws://${location.host}/ws`);

		let autoScroll = true; // Track whether to auto-scroll

		// Detect if user scrolls away from bottom
		log.addEventListener('scroll', () =>
		{
			autoScroll = log.scrollHeight - log.scrollTop <= log.clientHeight + 1;
		});
		
		function addLog(msg)
		{
			const entry = document.createElement('div');
			entry.className = 'log-entry';
			entry.innerHTML = `
          <span class='log-time'>${msg.time}</span>
          <span class='log-endpoint'>${msg.endpoint}</span>
          <span class='log-data'>${JSON.stringify(msg.data, null, "\t")}</span>
          <span class='log-data'>${msg.req == null || msg.req == "" ? "" :  JSON.stringify(msg.req, null, "\t")}</span>
        `;
			log.appendChild(entry);

			if (log.childElementCount > 500)
			{
				log.removeChild(log.firstChild);
			}

			if (autoScroll)
			{
				log.scrollTop = log.scrollHeight;
			}
		}

		function setStatus(id, val)
		{
			const el = document.getElementById(id);
			el.className = 'status ' + (val === true ? 'green' : val === false ? 'red' : 'yellow');
		}

		function renderHealth(data)
		{
			setStatus('gateway-status', data.gateway);
			const auth = data.authentication || {};
			setStatus('auth-status', auth.authenticated);
			setStatus('connected-status', auth.connected);
			setStatus('competing-status', !auth.competing);
		}

		async function updateHealth()
		{
			let data;

			try
			{
				const res = await fetch('/health');

				// Treat non-2xx responses as failures
				if (!res.ok)
				{
					throw new Error(`HTTP ${res.status}`);
				}

				// This may throw if the body is not valid JSON
				data = await res.json();
			} catch (err)
			{
				// Fallback object: adapt the shape to whatever renderHealth expects
				data = {
					gateway: false,
					authentication: {
						authenticated: false,
						connected: false,
						competing: true
					}
				};
				console.error('Failed to fetch health data:', err);
			}

			// Always called, no duplication
			renderHealth(data);
		}

		ws.onmessage = (ev) =>
		{
			const msg = JSON.parse(ev.data);
			addLog(msg);
			if (msg.endpoint === '/health')
			{
				renderHealth(msg.data);
			}
		};

		setInterval(updateHealth, 5000);
		updateHealth();
	</script>
</body>

</html>
